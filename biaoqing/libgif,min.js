(function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.SuperGif=t()})(this,function(){var e=function(e){return e.reduce(function(e,t){return 2*e+t},0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(e,t){for(var n,r,i=0,a=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(i>>3)&1<<(7&i)&&(n|=1<<r),i++;return n},o=[],l=1<<e,s=l+1,c=e+1,u=[],d=function(){u=[],c=e+1;for(var t=0;t<l;t++)u[t]=[t];u[l]=[],u[s]=null};;)if(r=n,n=a(c),n!==l){if(n===s)break;if(n<u.length)r!==l&&u.push(u[r].concat(u[n][0]));else{if(n!==u.length)throw new Error("Invalid LZW code.");u.push(u[r].concat(u[r][0]))}o.push.apply(o,u[n]),u.length===1<<c&&c<12&&c++}else d();return o},i=function(n,i){i||(i={});var a=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},o=function(){var e,t;t="";do e=n.readByte(),t+=n.read(e);while(0!==e);return t},l=function(){var r={};if(r.sig=n.read(3),r.ver=n.read(3),"GIF"!==r.sig)throw new Error("Not a GIF file.");r.width=n.readUnsigned(),r.height=n.readUnsigned();var o=t(n.readByte());r.gctFlag=o.shift(),r.colorRes=e(o.splice(0,3)),r.sorted=o.shift(),r.gctSize=e(o.splice(0,3)),r.bgColor=n.readByte(),r.pixelAspectRatio=n.readByte(),r.gctFlag&&(r.gct=a(1<<r.gctSize+1)),i.hdr&&i.hdr(r)},s=function(r){var a=function(r){var a=(n.readByte(),t(n.readByte()));r.reserved=a.splice(0,3),r.disposalMethod=e(a.splice(0,3)),r.userInput=a.shift(),r.transparencyGiven=a.shift(),r.delayTime=n.readUnsigned(),r.transparencyIndex=n.readByte(),r.terminator=n.readByte(),i.gce&&i.gce(r)},l=function(e){e.comment=o(),i.com&&i.com(e)},s=function(e){n.readByte();e.ptHeader=n.readBytes(12),e.ptData=o(),i.pte&&i.pte(e)},c=function(e){var t=function(e){n.readByte();e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),i.app&&i.app.NETSCAPE&&i.app.NETSCAPE(e)},r=function(e){e.appData=o(),i.app&&i.app[e.identifier]&&i.app[e.identifier](e)};n.readByte();switch(e.identifier=n.read(8),e.authCode=n.read(3),e.identifier){case"NETSCAPE":t(e);break;default:r(e)}},u=function(e){e.data=o(),i.unknown&&i.unknown(e)};switch(r.label=n.readByte(),r.label){case 249:r.extType="gce",a(r);break;case 254:r.extType="com",l(r);break;case 1:r.extType="pte",s(r);break;case 255:r.extType="app",c(r);break;default:r.extType="unknown",u(r)}},c=function(l){var s=function(e,t){for(var n=new Array(e.length),r=e.length/t,i=function(r,i){var a=e.slice(i*t,(i+1)*t);n.splice.apply(n,[r*t,t].concat(a))},a=[0,4,2,1],o=[8,8,4,2],l=0,s=0;s<4;s++)for(var c=a[s];c<r;c+=o[s])i(c,l),l++;return n};l.leftPos=n.readUnsigned(),l.topPos=n.readUnsigned(),l.width=n.readUnsigned(),l.height=n.readUnsigned();var c=t(n.readByte());l.lctFlag=c.shift(),l.interlaced=c.shift(),l.sorted=c.shift(),l.reserved=c.splice(0,2),l.lctSize=e(c.splice(0,3)),l.lctFlag&&(l.lct=a(1<<l.lctSize+1)),l.lzwMinCodeSize=n.readByte();var u=o();l.pixels=r(l.lzwMinCodeSize,u),l.interlaced&&(l.pixels=s(l.pixels,l.width)),i.img&&i.img(l)},u=function(){var e={};switch(e.sentinel=n.readByte(),String.fromCharCode(e.sentinel)){case"!":e.type="ext",s(e);break;case",":e.type="img",c(e);break;case";":e.type="eof",i.eof&&i.eof(e);break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}"eof"!==e.type&&setTimeout(u,0)},d=function(){l(),setTimeout(u,0)};d()},a=function(e){var t={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var r in e)t[r]=e[r];t.vp_w&&t.vp_h&&(t.is_vp=!0);var a,o,l=null,s=!1,c=null,u=null,d=null,h=null,p=null,f=null,g=null,y=!0,_=!0,w=!1,v=[],m=[],x=t.gif;"undefined"==typeof t.auto_play&&(t.auto_play=!x.getAttribute("rel:auto_play")||"1"==x.getAttribute("rel:auto_play"));var b,T,B,C,P=t.hasOwnProperty("on_end")?t.on_end:null,k=t.hasOwnProperty("loop_delay")?t.loop_delay:0,S=t.hasOwnProperty("loop_mode")?t.loop_mode:"auto",A=!t.hasOwnProperty("draw_while_loading")||t.draw_while_loading,E=!!A&&(!t.hasOwnProperty("show_progress_bar")||t.show_progress_bar),I=t.hasOwnProperty("progressbar_height")?t.progressbar_height:25,U=t.hasOwnProperty("progressbar_background_color")?t.progressbar_background_color:"rgba(255,255,255,0.4)",O=t.hasOwnProperty("progressbar_foreground_color")?t.progressbar_foreground_color:"rgba(255,0,22,.8)",R=function(){c=null,u=null,p=d,d=null,f=null},z=function(){try{i(a,Z)}catch(e){M("parse")}},N=function(e,t){b.width=e*K(),b.height=t*K(),B.style.minWidth=e*K()+"px",C.width=e,C.height=t,C.style.width=e+"px",C.style.height=t+"px",C.getContext("2d").setTransform(1,0,0,1,0,0)},D=function(e,t){return m[e]?("undefined"!=typeof t.x&&(m[e].x=t.x),void("undefined"!=typeof t.y&&(m[e].y=t.y))):void(m[e]=t)},F=function(e,n,r){if(r&&E){var i,a,o,l,s=I;if(t.is_vp){w?(o=(t.vp_t+t.vp_h-s)/K(),s/=K(),i=t.vp_l/K(),a=i+e/n*(t.vp_w/K()),l=b.width/K()):(o=t.vp_t+t.vp_h-s,s=s,i=t.vp_l,a=i+e/n*t.vp_w,l=b.width)}else o=(b.height-s)/(w?K():1),a=e/n*b.width/(w?K():1),l=b.width/(w?K():1),s/=w?K():1;T.fillStyle=U,T.fillRect(a,o,l-a,s),T.fillStyle=O,T.fillRect(0,o,a,s)}},M=function(e){var n=function(){T.fillStyle="black",T.fillRect(0,0,t.c_w?t.c_w:o.width,t.c_h?t.c_h:o.height),T.strokeStyle="red",T.lineWidth=3,T.moveTo(0,0),T.lineTo(t.c_w?t.c_w:o.width,t.c_h?t.c_h:o.height),T.moveTo(0,t.c_h?t.c_h:o.height),T.lineTo(t.c_w?t.c_w:o.width,0),T.stroke()};l=e,o={width:x.width,height:x.height},v=[],n()},G=function(e){o=e,N(o.width,o.height)},j=function(e){W(),R(),c=e.transparencyGiven?e.transparencyIndex:null,u=e.delayTime,d=e.disposalMethod},W=function(){f&&(v.push({data:f.getImageData(0,0,o.width,o.height),delay:u}),m.push({x:0,y:0}))},H=function(e){f||(f=C.getContext("2d"));var n=v.length,r=e.lctFlag?e.lct:o.gct;n>0&&(3===p?null!==h?f.putImageData(v[h].data,0,0):f.clearRect(g.leftPos,g.topPos,g.width,g.height):h=n-1,2===p&&f.clearRect(g.leftPos,g.topPos,g.width,g.height));var i=f.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach(function(e,t){e!==c&&(i.data[4*t+0]=r[e][0],i.data[4*t+1]=r[e][1],i.data[4*t+2]=r[e][2],i.data[4*t+3]=255)}),f.putImageData(i,e.leftPos,e.topPos),w||(T.scale(K(),K()),w=!0),A&&(T.drawImage(C,0,0),A=t.auto_play),g=e},q=function(){var e=-1,n=0,r=function(){var t=_?1:-1;return(e+t+v.length)%v.length},i=function(t){e+=t,o()},a=function(){var t=!1,a=function(){null!==P&&P(x),n++,S!==!1||n<0?o():(t=!1,y=!1)},o=function(){if(t=y){i(1);var n=10*v[e].delay;n||(n=100);var l=r();0===l?(n+=k,setTimeout(a,n)):setTimeout(o,n)}};return function(){t||setTimeout(o,0)}}(),o=function(){var t;e=parseInt(e,10),e>v.length-1&&(e=0),e<0&&(e=0),t=m[e],C.getContext("2d").putImageData(v[e].data,t.x,t.y),T.globalCompositeOperation="copy",T.drawImage(C,0,0)},s=function(){y=!0,a()},c=function(){y=!1};return{init:function(){l||(t.c_w&&t.c_h||T.scale(K(),K()),t.auto_play?a():(e=0,o()))},step:a,play:s,pause:c,playing:y,move_relative:i,current_frame:function(){return e},length:function(){return v.length},move_to:function(t){e=t,o()}}}(),L=function(e){F(a.pos,a.data.length,e)},V=function(){},X=function(e,t){return function(n){e(n),L(t)}},Z={hdr:X(G),gce:X(j),com:X(V),app:{NETSCAPE:X(V)},img:X(H,!0),eof:function(e){W(),L(!1),t.c_w&&t.c_h||(b.width=o.width*K(),b.height=o.height*K()),q.init(),s=!1,Y&&Y(x)}},J=function(){var e=x.parentNode,n=document.createElement("div");b=document.createElement("canvas"),T=b.getContext("2d"),B=document.createElement("div"),C=document.createElement("canvas"),n.width=b.width=x.width,n.height=b.height=x.height,B.style.minWidth=x.width+"px",n.className="jsgif",B.className="jsgif_toolbar",n.appendChild(b),n.appendChild(B),e.insertBefore(n,x),e.removeChild(x),t.c_w&&t.c_h&&N(t.c_w,t.c_h),Q=!0},K=function(){var e;return e=t.max_width&&o&&o.width>t.max_width?t.max_width/o.width:1},Q=!1,Y=!1,$=function(e){return!s&&(Y=!!e&&e,s=!0,v=[],R(),h=null,p=null,f=null,g=null,!0)};return{play:q.play,pause:q.pause,move_relative:q.move_relative,move_to:q.move_to,get_playing:function(){return y},get_canvas:function(){return b},get_canvas_scale:function(){return K()},get_loading:function(){return s},get_auto_play:function(){return t.auto_play},get_length:function(){return q.length()},get_current_frame:function(){return q.current_frame()},load_url:function(e,t){if($(t)){var r=new XMLHttpRequest;r.open("GET",e,!0),"overrideMimeType"in r?r.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in r?r.responseType="arraybuffer":r.setRequestHeader("Accept-Charset","x-user-defined"),r.onloadstart=function(){Q||J()},r.onload=function(e){200!=this.status&&M("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var t=this.response;t.toString().indexOf("ArrayBuffer")>0&&(t=new Uint8Array(t)),a=new n(t),setTimeout(z,0)},r.onprogress=function(e){e.lengthComputable&&F(e.loaded,e.total,!0)},r.onerror=function(){M("xhr")},r.send()}},load:function(e){this.load_url(x.getAttribute("rel:animated_src")||x.src,e)},load_raw:function(e,t){$(t)&&(Q||J(),a=new n(e),setTimeout(z,0))},set_frame_offset:D}};return a});